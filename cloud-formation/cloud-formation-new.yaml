AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template to deploy TripMateAI application with dynamic secrets and API Gateway endpoints.

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances

Resources:
  # VPC
  TripMateVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: TripMateVPC

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: TripMateInternetGateway

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref TripMateVPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TripMateVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: TripMatePublicSubnet

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TripMateVPC
      Tags:
        - Key: Name
          Value: TripMatePublicRouteTable

  # Routes
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Subnet Route Table Associations
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Security Groups
  FrontendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and SSH access to the frontend instance
      VpcId: !Ref TripMateVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0 
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: TripMateFrontendSG

  BackendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow traffic from the frontend instance and SSH access
      VpcId: !Ref TripMateVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          SourceSecurityGroupId: !Ref FrontendSecurityGroup
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref FrontendSecurityGroup
      Tags:
        - Key: Name
          Value: TripMateBackendSG

  # Cognito User Pool
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: TripMateUserPool
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true

  # Cognito User Pool Client
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: TripMateUserPoolClient
      UserPoolId: !Ref CognitoUserPool
      GenerateSecret: true
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
        - code
        - implicit
      AllowedOAuthScopes:
        - email
        - openid
        - aws.cognito.signin.user.admin
      CallbackURLs:
        - 'https://localhost/'
      LogoutURLs:
        - 'https://localhost/'

  # S3 Bucket
  TripItineraryBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'trip-itinerary-${AWS::AccountId}-${AWS::Region}'
      AccessControl: Private

  # DynamoDB Table
  TripRecordsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: 'TripRecords'
      AttributeDefinitions:
        - AttributeName: 'TripId'
          AttributeType: 'S'
      KeySchema:
        - AttributeName: 'TripId'
          KeyType: 'HASH'
      BillingMode: PAY_PER_REQUEST

  # Secrets Manager Secret for AWS Secrets
  TripMateAWSSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: 'trip_mate/awssecrets'
      Description: 'AWS secrets for TripMate application'
      SecretString: !Sub |
        {
          "REGION": "${AWS::Region}",
          "USER_POOL_ID": "${CognitoUserPool}",
          "CLIENT_ID": "${CognitoUserPoolClient}",
          "CLIENT_SECRET": "${CognitoUserPoolClient.ClientSecret}",
          "BUCKET_NAME": "${TripItineraryBucket}"
        }

  # Secrets Manager Secret for GCP Secrets
  TripMateGCPSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: 'trip_mate/gcpsecrets'
      Description: 'GCP service account secret key for TripMate application'
      SecretString: !Sub |
        {
          "type": "service_account",
          "project_id": "csci-5410-442522",
          "private_key_id": "67958c33f876561806e698bc795c5dec98d4e2fe",
          "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCiRkbDeomD0JSF\n3Cg/fE2Ihs6wmFjEr7vaB53JFa1op2Smzec+n7TU7J3WoehmT2CoGUqfsKoZJw7/\nKHf/L6Zc0Nki/xjOekGWKclSnuhdExvwdzHrBcWOBY98nODU+0fWUVGl/hA1tMA1\nyuTsXHI9TMuLvOzgpP7T4LsvGp3r7Vq7g0CemtQeUQXZ8b9eGJ9zYiV9CpVa7Wcb\ns+Lio0WnM4ONjiir5DhxM2/WVrYtC6hTLj4eBELkeR94BLLneBg4HyIL5r7KCKQ+\nM7rwtvLDSPsWOV5LHSDH1PVop6mgXc2MMzxaMJkozUxuH4mL8XeLY7MdmS1qUOl6\nDJLeIwLJAgMBAAECggEAInLyV1HGazQGr7Mo3S9dg1ABBWbWI20eHz9SLQvbzBWL\nLckU4AvF9xTDPjsRa9TKk20JFUULGztaOOtFrCgYtGgGzKHkiYLVNRRqX46KDCZA\nHmijcX4AbjG6gA0KwtQUcEhDoc5BcTFNw62uswm+G8rXhDMHg3ored3hxvJq15ht\nD+VpTj/oTQ0GSavtej374c5ff55qBBYMdrPPjs3MCHvieFUBo1w6HB+6naibCrX7\nIwBiEInDMOtl1rAYL0p5fY8DhZOmsmuB4ZFPLbsUQRWFQbq5NjGoBO2RjCa5R1/s\nrv64sbh84cCOD8OjEbPHboQilEmVfaRD5OxqR6/zTQKBgQDibGp34WYpnzzI7+Xf\nsUl1/t3piSluZZyioogBnvGztlJJTZMI/uHv8KBkm/NjJuCibAuUcdO2A3Vj+h05\nDvvbu/nWUlJHrPWJPyq5zjBLU1RluuPOhsvQA8k9GCpJhWGXJdHF0mxyKT4J2+Zo\nNCY0xbFFvg6FmoVsi6IQzzbOHQKBgQC3eLk8hUO+gx8Dq++++XPASXf/No88W6AE\nXAUn+GzHVD99LWbO1g7dcmnlbATaYEnDgo765LR8b1N+SmE3HAtDDHW48FKQWTCF\nqp/eiWu63qbUtsLyyRTHZWpixYU6o/HbSrjaJ9wsEobntEYmzmRSbh59r8Op+7+q\nRDKTiWoXnQKBgQC98z4OfCV83X3dBITQeKasOrhoZw0+9DfHqJp44aLbpSS7Ij0r\n2sgoxrGINdylXcQt/n5odmWp2JTu3rENYSihWr1ps34ba1pBXaC2Z+fUCYBQJ81d\nQXBSfhqhCljPfPo2FyA42SLpUvgcxUIyQS2cMA1b+Omt48fzG+FGQNA1cQKBgE5s\nNtlsqSlMyLv8CU1bOSPvA3C+dHk7POnAH6AXKwAEveKWvoQYsV/soOEky+pAECeW\nreEGUzOBLnIj/uvce9/b+pHjf5cd2IS6Cv3HRZopw6vWtvuqAcy9R70SasFHBIFU\nrjDpqs3X2Xw+7WF3BSDK2xOkRoFpD2MLJYc0zHltAoGBAIfrhX7lddpyTxLl5nte\nJ3K5TaJFHyIhATB2accSxyih/zQmEhz9JU9hibFSRzOkU5hwtCrMRIPJPG/kGzMn\ncIz1KB1HyQ3h+E73QQGA5/7mKvSvfoVaWmChFVgOQwgzVxBqPGNsMmuHj8yWk1mZ\nHUv6IyXlAZkBU6OxkGd0jCYk\n-----END PRIVATE KEY-----\n",
          "client_email": "vertexai@csci-5410-442522.iam.gserviceaccount.com",
          "client_id": "106152084513626917135",
          "auth_uri": "https://accounts.google.com/o/oauth2/auth",
          "token_uri": "https://oauth2.googleapis.com/token",
          "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
          "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/vertexai%40csci-5410-442522.iam.gserviceaccount.com",
          "universe_domain": "googleapis.com"
        }


  # Lambda Functions
  FetchAWSSecretsLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'FetchAWSSecretsLambda-${AWS::StackName}'
      Handler: index.lambda_handler
      Role: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
      Runtime: python3.9
      Code:
        ZipFile: |
          import boto3
          import json

          def lambda_handler(event, context):
              secret_name = "trip_mate/awssecrets"
              region_name = "us-east-1"

              client = boto3.client("secretsmanager", region_name=region_name)

              try:
                  response = client.get_secret_value(SecretId=secret_name)
                  secret = json.loads(response["SecretString"])
                  
                  return {
                      "statusCode": 200,
                      "body": json.dumps({
                          "message": "AWS Secret fetched successfully",
                          "secret": secret
                      })
                  }
              except Exception as e:
                  return {
                      "statusCode": 500,
                      "body": json.dumps({"error": str(e)})
                  }

  FetchGCPSecretsLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'FetchGCPSecretsLambda-${AWS::StackName}'
      Handler: index.lambda_handler
      Role: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
      Runtime: python3.9
      Code:
        ZipFile: |
          import boto3
          import json

          def lambda_handler(event, context):
              secret_name = "trip_mate/gcpsecrets"
              region_name = "us-east-1"

              client = boto3.client("secretsmanager", region_name=region_name)

              try:
                  response = client.get_secret_value(SecretId=secret_name)
                  secret = json.loads(response["SecretString"])
                  
                  return {
                      "statusCode": 200,
                      "body": json.dumps({
                          "message": "GCP Secret fetched successfully",
                          "secret": secret
                      })
                  }
              except Exception as e:
                  return {
                      "statusCode": 500,
                      "body": json.dumps({"error": str(e)})
                  }

  # API Gateway for Lambda Functions
  AWSSecretsApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: 'AWSSecretsApi'

  AWSSecretsApiResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AWSSecretsApi
      ParentId: !GetAtt [AWSSecretsApi, RootResourceId]
      PathPart: 'awssecrets'

  AWSSecretsApiMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AWSSecretsApi
      ResourceId: !Ref AWSSecretsApiResource
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations'
          - LambdaArn: !GetAtt FetchAWSSecretsLambda.Arn

  AWSSecretsApiDeployment:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref AWSSecretsApi
      StageName: 'prod'
    DependsOn:
      - AWSSecretsApiMethod

  PermissionForApiToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FetchAWSSecretsLambda
      Action: 'lambda:InvokeFunction'
      Principal: 'apigateway.amazonaws.com'
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AWSSecretsApi}/*/GET/awssecrets'

  GCPSecretsApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: 'GCPSecretsApi'

  GCPSecretsApiResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref GCPSecretsApi
      ParentId: !GetAtt [GCPSecretsApi, RootResourceId]
      PathPart: 'gcpsecrets'

  GCPSecretsApiMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref GCPSecretsApi
      ResourceId: !Ref GCPSecretsApiResource
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations'
          - LambdaArn: !GetAtt FetchGCPSecretsLambda.Arn

  GCPSecretsApiDeployment:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref GCPSecretsApi
      StageName: 'prod'
    DependsOn:
      - GCPSecretsApiMethod

  PermissionForApiToInvokeLambdaGCP:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FetchGCPSecretsLambda
      Action: 'lambda:InvokeFunction'
      Principal: 'apigateway.amazonaws.com'
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GCPSecretsApi}/*/GET/gcpsecrets'

  # EC2 Instances
  BackendInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.small
      KeyName: !Ref KeyName
      ImageId: ami-0453ec754f44f9a4a  # Amazon Linux 2023 AMI
      NetworkInterfaces:
        - DeviceIndex: 0
          SubnetId: !Ref PublicSubnet
          PrivateIpAddress: 10.0.1.10
          AssociatePublicIpAddress: false
          GroupSet:
            - !Ref BackendSecurityGroup
      UserData:
        Fn::Base64:
          Fn::Sub:
            - |
              #!/bin/bash
              sudo su
              yum update -y
              yum install -y gcc-c++ make
              curl -sL https://rpm.nodesource.com/setup_18.x | bash -
              yum install -y nodejs
              yum install -y git
              cd /home/ec2-user
              git clone https://github.com/risvarrt/TripMateAI.git
              cd TripMateAI/backend
              npm install
              echo 'export LAMBDA_AWS_SECRET_URL="${AWSSecretsApiUrl}"' >> /etc/environment
              echo 'export LAMBDA_GCP_SECRET_URL="${GCPSecretsApiUrl}"' >> /etc/environment
              source /etc/environment
              nohup node server.js > server.log 2>&1 &
            - AWSSecretsApiUrl: !Sub 'https://${AWSSecretsApi}.execute-api.${AWS::Region}.amazonaws.com/prod/awssecrets'
              GCPSecretsApiUrl: !Sub 'https://${GCPSecretsApi}.execute-api.${AWS::Region}.amazonaws.com/prod/gcpsecrets'

  FrontendInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.small
      KeyName: !Ref KeyName
      ImageId: ami-0453ec754f44f9a4a # Amazon Linux 2023 AMI
      NetworkInterfaces:
        - AssociatePublicIpAddress: "true"
          DeviceIndex: "0"
          SubnetId: !Ref PublicSubnet
          GroupSet:
            - !Ref FrontendSecurityGroup
      UserData:
        Fn::Base64:
          Fn::Sub: 
            - |
              #!/bin/bash
              sudo yum update -y
              sudo yum install -y git gcc-c++ make
              curl -sL https://rpm.nodesource.com/setup_18.x | sudo bash -
              sudo yum install -y nodejs
              cd /home/ec2-user
              git clone https://github.com/risvarrt/TripMateAI.git
              cd TripMateAI/frontend
              echo "export VUE_APP_BACKEND_URL=http://${BackendInstance.PublicIp}:8080" > /etc/environment
              source /etc/environment
              npm install
              npm run build
              nohup npx serve -s dist --listen 8080 > /home/ec2-user/frontend.log 2>&1 &

Outputs:
  FrontendPublicIP:
    Description: Public IP address of the frontend EC2 instance
    Value: !GetAtt FrontendInstance.PublicIp

  BackendInstancePrivateIP:
    Description: The private IP of the backend EC2 instance
    Value: !GetAtt BackendInstance.PrivateIpAddress

  AWSSecretsApiUrl:
    Description: URL for AWS Secrets API
    Value: !Sub 'https://${AWSSecretsApi}.execute-api.${AWS::Region}.amazonaws.com/prod/awssecrets'

  GCPSecretsApiUrl:
    Description: URL for GCP Secrets API
    Value: !Sub 'https://${GCPSecretsApi}.execute-api.${AWS::Region}.amazonaws.com/prod/gcpsecrets'
