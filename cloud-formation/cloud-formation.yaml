AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template to deploy TripMateAI application with dynamic secrets and API Gateway endpoints.

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances

Resources:
  # VPC
  TripMateVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: TripMateVPC

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: TripMateInternetGateway

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref TripMateVPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TripMateVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: TripMatePublicSubnet

  # Private Subnet
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref TripMateVPC
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: TripMatePrivateSubnet

  # NAT Gateway EIP
  NatEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  # NAT Gateway
  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: TripMateNatGateway

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TripMateVPC
      Tags:
        - Key: Name
          Value: TripMatePublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref TripMateVPC
      Tags:
        - Key: Name
          Value: TripMatePrivateRouteTable

  # Routes
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  # Subnet Route Table Associations
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  PrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  # Security Groups
  FrontendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and SSH access to the frontend instance
      VpcId: !Ref TripMateVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: TripMateFrontendSG

  BackendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow inbound traffic from frontend to backend instance
      VpcId: !Ref TripMateVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          SourceSecurityGroupId: !Ref FrontendSecurityGroup
      Tags:
        - Key: Name
          Value: TripMateBackendSG

  # Cognito User Pool
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: TripMateUserPool
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true

  # Cognito User Pool Client
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: TripMateUserPoolClient
      UserPoolId: !Ref CognitoUserPool
      GenerateSecret: true
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
        - code
        - implicit
      AllowedOAuthScopes:
        - email
        - openid
        - aws.cognito.signin.user.admin
      CallbackURLs:
        - 'https://localhost/'  # Update as needed
      LogoutURLs:
        - 'https://localhost/'  # Update as needed

  # S3 Bucket
  TripItineraryBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'trip-itinerary-${AWS::AccountId}-${AWS::Region}'
      AccessControl: Private

  # DynamoDB Table
  TripRecordsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: 'TripRecords'
      AttributeDefinitions:
        - AttributeName: 'TripId'
          AttributeType: 'S'
      KeySchema:
        - AttributeName: 'TripId'
          KeyType: 'HASH'
      BillingMode: PAY_PER_REQUEST

  # Secrets Manager Secret for AWS Secrets
  TripMateAWSSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: 'trip_mate/awssecrets'
      Description: 'AWS secrets for TripMate application'
      SecretString: !Sub |
        {
          "REGION": "${AWS::Region}",
          "USER_POOL_ID": "${CognitoUserPool}",
          "CLIENT_ID": "${CognitoUserPoolClient}",
          "CLIENT_SECRET": "${CognitoUserPoolClient.ClientSecret}",
          "BUCKET_NAME": "${TripItineraryBucket}"
        }

  # Secrets Manager Secret for GCP Secrets
  TripMateGCPSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: 'trip_mate/gcpsecrets'
      Description: 'GCP service account secret key for TripMate application'
      SecretString: !Sub |
        {
          "type": "service_account",
          "project_id": "csci-5409-441200",
          "private_key_id": "3e876002605790fe44d7b8419a162a90d54ad676",
          "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDGluxE8g99C8x2\nybtOBUIQe2KbQ3gHUNsSgvg6K6XuOj68A1R7os/QlLOafwt3Rfg0w5s6oKkTNX+o\nihzXgOhJOviYQTpK3O7JRORCZGyaI++FrpZqr9ajetn+3+M3EltW1tWJyj1LiV0E\nP1ii3Bl0N+jEaBDqrgK8uyoeyrxGdFOUogAuURFX5wHiHTOspSQ9+8c1cjb98fXg\nr42aGUVKLhS84ZsT3Rptl7qOMn/rqHi6S85k9Vp5UHXfYZ3Q1WGGqDSO5QnKn0KC\nUK0kNk5zJTWSTywW8jAEmA/sUVZlLXoC6NWGjUZjfAgJzs1Qv6wPem09qSp3Kl15\n35Co/saJAgMBAAECggEAFUqPToWGwlT6YQZ4G9Ftv7Ng0y1owB0Lvch3qVHubnQF\nb5YqT76ZCf91YZQrJCim565MlVyt/+KZmxXiqXq3PMmzJyzAHZBiFAdcMx+N8rk1\nWAdrtki/qgOU/XHezBPeYdky5/zcNT3nEHpjrANNwdNwM+WF4clR/w7QgWBiTum/\nuv1lS4Fwn8de3GsOA8NixcLsJbfozKpswQQAITU9/Izml73OIXOZy4uQwBrclgP9\nth28hId2BbUWVRNR0Vv469e7xBZIood4ThI+vdTObFeGIjaCbccGP8f3x0GK9zGb\nuqwfUCMnihDIfHvvT27juYogfje9060edEbTbgY3wQKBgQDrejAVe7U8Sm6oowt5\nuJDQQ43HlNtYAOr2cCSqK1MQkvYXUnt0/GnCM8mZTemc4aNe9ICpXqFK63vPZ3ZM\nCaaP/gFFAx/hxdF4jcvU/zfE9j8R9kl68/FFVb9HxWcFdxCvJ1maKxtv2qTYAqq0\nWmS3ZLXAZOzHuEETUmxhWSH/QQKBgQDX5bhdka1nBcqz8qEAZqQfi0xlWv0rGw8i\neSU32iZ9X3nI5lQ1qr2oITLyMdt1hJviXbUm2IpfgwF3pjCKAx/sx5T3FdS7okzh\nvZe12kZ0Dygc9fDpAv91WW7FHFeddLvk4ATcLDIA5kFOAzfVhwvWeGTzzstix9bx\n4xbaaFq9SQKBgQDLDqjcPbtBbGYUYdUJd9DY5wgh7Qlg0BnNvVLAs2+DwVcZMXVo\noimI4COeYYNsV18MCQfSBdpMwtgXN/7Y/xF05fKuUk1x4aYKsSvuVs7+t+IXWSxw\nLGAIDDNQbreyDMSEZghsW3PjdsXjyBjwQWrMgroAWIeeihMD2HXBVJ1ugQKBgCxU\nxjuoWxPJc6rpije7272Ca+hv+4YrYzsv5v2F9NtPjIE9ElOGwLTSRFTI+ggyd5PO\nrBDS6+7axqVb4aGlLJwBC0yFFg6FMAY2WP2FWWwhZJo1wgcGj4/4Ei+1NyRkwOQp\nP7Y5+PaIUSaEsKVOupaKWChb8RVSdYdrmti0DtXJAoGBALEuD+GAPE83cIJlXwO8\nRw8Y7LzkpPGa1yqqjJuWHDCxgD/6ZUHT5xrgWnTPbYmqWL0zfmDj4AUTb9b69yFC\nmqelIUhS1YgE/IhBvHGoMRRoLxlMB+qc3ghL1q1Ahjpv/2GPAhFBlcaA7k+OXmRR\nIsuh2ulL3B4DbEl+qc6GIYhj\n-----END PRIVATE KEY-----\n",
          "client_email": "vertex@csci-5409-441200.iam.gserviceaccount.com",
          "client_id": "114619192574527969983",
          "auth_uri": "https://accounts.google.com/o/oauth2/auth",
          "token_uri": "https://oauth2.googleapis.com/token",
          "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
          "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/vertex%40csci-5409-441200.iam.gserviceaccount.com",
          "universe_domain": "googleapis.com"
        }

  # Lambda Functions
  FetchAWSSecretsLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'FetchAWSSecretsLambda-${AWS::StackName}'
      Handler: index.lambda_handler
      Role: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
      Runtime: python3.9
      Code:
        ZipFile: |
          import boto3
          import json

          def lambda_handler(event, context):
              secret_name = "tripmate/awssecrets"
              region_name = event.get('region_name', '${AWS::Region}')

              # Create a Secrets Manager client
              client = boto3.client("secretsmanager", region_name=region_name)

              try:
                  # Fetch the secret value
                  response = client.get_secret_value(SecretId=secret_name)
                  secret = json.loads(response["SecretString"])
                  
                  return {
                      "statusCode": 200,
                      "body": json.dumps({
                          "message": "AWS Secret fetched successfully",
                          "secret": secret
                      })
                  }
              except Exception as e:
                  return {
                      "statusCode": 500,
                      "body": json.dumps({"error": str(e)})
                  }

  FetchGCPSecretsLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'FetchGCPSecretsLambda-${AWS::StackName}'
      Handler: index.lambda_handler
      Role: !Sub 'arn:aws:iam::${AWS::AccountId}:role/LabRole'
      Runtime: python3.9
      Code:
        ZipFile: |
          import boto3
          import json

          def lambda_handler(event, context):
              secret_name = "tripmate/gcpsecrets"
              region_name = event.get('region_name', '${AWS::Region}')

              # Create a Secrets Manager client
              client = boto3.client("secretsmanager", region_name=region_name)

              try:
                  # Fetch the secret value
                  response = client.get_secret_value(SecretId=secret_name)
                  secret = json.loads(response["SecretString"])
                  
                  return {
                      "statusCode": 200,
                      "body": json.dumps({
                          "message": "GCP Secret fetched successfully",
                          "secret": secret
                      })
                  }
              except Exception as e:
                  return {
                      "statusCode": 500,
                      "body": json.dumps({"error": str(e)})
                  }

  # API Gateway for Lambda Functions
  AWSSecretsApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: 'AWSSecretsApi'

  AWSSecretsApiResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AWSSecretsApi
      ParentId: !GetAtt [AWSSecretsApi, RootResourceId]
      PathPart: 'awssecrets'

  AWSSecretsApiMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AWSSecretsApi
      ResourceId: !Ref AWSSecretsApiResource
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations'
          - LambdaArn: !GetAtt FetchAWSSecretsLambda.Arn

  AWSSecretsApiDeployment:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref AWSSecretsApi
      StageName: 'prod'
    DependsOn:
      - AWSSecretsApiMethod

  PermissionForApiToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FetchAWSSecretsLambda
      Action: 'lambda:InvokeFunction'
      Principal: 'apigateway.amazonaws.com'
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AWSSecretsApi}/*/GET/awssecrets'

  GCPSecretsApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: 'GCPSecretsApi'

  GCPSecretsApiResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref GCPSecretsApi
      ParentId: !GetAtt [GCPSecretsApi, RootResourceId]
      PathPart: 'gcpsecrets'

  GCPSecretsApiMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref GCPSecretsApi
      ResourceId: !Ref GCPSecretsApiResource
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaArn}/invocations'
          - LambdaArn: !GetAtt FetchGCPSecretsLambda.Arn

  GCPSecretsApiDeployment:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref GCPSecretsApi
      StageName: 'prod'
    DependsOn:
      - GCPSecretsApiMethod

  PermissionForApiToInvokeLambdaGCP:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FetchGCPSecretsLambda
      Action: 'lambda:InvokeFunction'
      Principal: 'apigateway.amazonaws.com'
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${GCPSecretsApi}/*/GET/gcpsecrets'

  # EC2 Instances
  BackendInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.small
      KeyName: !Ref KeyName
      ImageId: ami-0453ec754f44f9a4a  # Amazon Linux 2023 AMI
      SubnetId: !Ref PrivateSubnet
      PrivateIpAddress: 10.0.2.10
      SecurityGroupIds:
        - !Ref BackendSecurityGroup
      UserData:
        Fn::Base64:
          Fn::Sub:
            - |
              #!/bin/bash
              sudo su
              yum update -y
              yum install -y gcc-c++ make
              curl -sL https://rpm.nodesource.com/setup_18.x | bash -
              yum install -y nodejs
              yum install -y git
              cd /home/ec2-user
              git clone https://github.com/risvarrt/TripMateAI.git
              cd TripMateAI/backend
              npm install
              echo 'export LAMBDA_AWS_SECRET_URL="${AWSSecretsApiUrl}"' >> ~/.bash_profile
              echo 'export LAMBDA_GCP_SECRET_URL="${GCPSecretsApiUrl}"' >> ~/.bash_profile
              source ~/.bash_profile
              # Start the backend application
              nohup node server.js > server.log 2>&1 &
            - AWSSecretsApiUrl: !Sub 'https://${AWSSecretsApi}.execute-api.${AWS::Region}.amazonaws.com/prod/awssecrets'
              GCPSecretsApiUrl: !Sub 'https://${GCPSecretsApi}.execute-api.${AWS::Region}.amazonaws.com/prod/gcpsecrets'

  FrontendInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.small
      KeyName: !Ref KeyName
      ImageId: ami-0453ec754f44f9a4a # Amazon Linux 2023 AMI
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref FrontendSecurityGroup
      UserData:
        Fn::Base64:
          Fn::Sub: 
            - |
              #!/bin/bash
              sudo su
              yum update -y
              yum install -y gcc-c++ make
              curl -sL https://rpm.nodesource.com/setup_18.x | bash -
              yum install -y nodejs
              yum install -y git
              cd /home/ec2-user
              git clone https://github.com/risvarrt/TripMateAI.git
              cd TripMateAI/frontend
              npm install
              echo 'export VUE_APP_BACKEND_URL="http://${BackendPrivateIP}:3000"' >> ~/.bash_profile
              source ~/.bash_profile
              # Start the frontend application
              nohup npm run serve -- --port 8080 --host 0.0.0.0 > frontend.log 2>&1 &
            - BackendPrivateIP: !GetAtt BackendInstance.PrivateIpAddress

Outputs:
  FrontendPublicIP:
    Description: Public IP address of the frontend EC2 instance
    Value: !GetAtt FrontendInstance.PublicIp
